import os
import numpy as np
import librosa
from scipy.signal import butter, lfilter
from tqdm import tqdm   # ‚≠ê added

# ---------------- CONFIG ----------------
TANK_DIR = r"C:/Users/shikh/OneDrive/Desktop/Project/Output"
NONTANK_DIR = r"C:/Users/shikh/OneDrive/Desktop/Project/Output2"

SAMPLE_RATE = 16000
LOWCUT = 20
HIGHCUT = 500

N_MFCC = 13
# ----------------------------------------


# Band-pass filter
def bandpass_filter(signal, sr, lowcut, highcut, order=4):
    nyq = 0.5 * sr
    low = lowcut / nyq
    high = highcut / nyq
    b, a = butter(order, [low, high], btype="band")
    return lfilter(b, a, signal)


def extract_features(file_path):
    # Load audio
    y, sr = librosa.load(file_path, sr=SAMPLE_RATE, mono=True)

    # Apply band-pass (same for all classes)
    y = bandpass_filter(y, sr, LOWCUT, HIGHCUT)

    # MFCC
    mfcc = librosa.feature.mfcc(y=y, sr=sr, n_mfcc=N_MFCC)

    # Delta & Delta-Delta
    delta = librosa.feature.delta(mfcc)
    delta2 = librosa.feature.delta(mfcc, order=2)

    # Stack features
    features = np.vstack([mfcc, delta, delta2])

    # Statistical aggregation
    mean = np.mean(features, axis=1)
    var = np.var(features, axis=1)

    return np.hstack([mean, var])


# -------- DATASET BUILDING --------
X = []
y = []

# Tank = 1
tank_files = [f for f in os.listdir(TANK_DIR) if f.endswith(".wav")]
for file in tqdm(tank_files, desc="Processing TANK sounds", unit="file"):
    path = os.path.join(TANK_DIR, file)
    X.append(extract_features(path))
    y.append(1)

# Non-tank = 0
nontank_files = [f for f in os.listdir(NONTANK_DIR) if f.endswith(".wav")]
for file in tqdm(nontank_files, desc="Processing NON-TANK sounds", unit="file"):
    path = os.path.join(NONTANK_DIR, file)
    X.append(extract_features(path))
    y.append(0)

X = np.array(X)
y = np.array(y)

print("\nFeature matrix shape:", X.shape)
print("Labels shape:", y.shape)

# Save for training
np.save("X_features.npy", X)
np.save("y_labels.npy", y)
